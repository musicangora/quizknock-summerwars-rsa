# quizknock-summerwars-rsa
 QuizKnockの企画動画で学ぶRSA暗号
 
 [![](https://img.youtube.com/vi/kvC55N4k9ng/0.jpg)](https://www.youtube.com/watch?v=kvC55N4k9ng)
 
 🔗https://www.youtube.com/watch?v=kvC55N4k9ng

夏になると見たくなる、映画「サマーウォーズ」では、主人公の健二が世界の危機を救うために暗算で暗号を解くシーンがある。実際何をしているのかよくわからないまま楽しんでいる人も多いだろうが、彼はとんでもないことをしている。

健二が説いた暗号は、RSA暗号だと言われている。RSA暗号は、現在様々なとことで使われている暗号方式で、公開鍵と秘密鍵の2つの鍵を使って暗号化する「公開鍵暗号方式」の一つである。QuizKnockの皆さんがこのRSA暗号を暗算で解くことで、暗号方式と健二のすごさを非常にわかりやすく説明してくれている。今回はこれを題材にPythonで実装することで、RSA暗号の仕組みと、健二のすごさと、計算機のありがたみを感じようというものである。

## RSA暗号
RSA暗号は公開鍵暗号方式の1つである。公開鍵暗号方式とは、公開鍵と秘密鍵の2つの鍵を使った暗号方式で、暗号化に使う鍵の1つを他人に知られても良いという特徴がある。

これまでの暗号は、1つの秘密鍵だけで暗号化していた。例えば、「一文字ずらす」という鍵で「こんにちは」を暗号化すると「さあぬつひ」となる。暗号文を受け取った相手が「一文字ずらす」という鍵を使って復号化する。正確ではないがイメージとしてはだいたいこんな感じである。しかし、この鍵を知ってれいれば誰でも復号化できるため、秘密鍵をいかに安全に相手に送るかが課題になっていた。

Aさんが暗号文と一緒に秘密鍵をBさんに送ったとする。このとき悪意のあるCさんがこの通信を傍受すれば暗号文とそれを復号する鍵を同時に手に入れてしまう。そこでAさんは工夫して、暗号文と秘密鍵を別々で送ったとする。しかし悪意あるCさんはその通信をすべて傍受できているのでこれでは意味はない。Aさんはさらに工夫して秘密鍵を別の暗号で暗号化して送ったとする。確かにこれでCさんに傍受されても暗号は復号化されないかもしれないが、次は秘密鍵を復号化する秘密鍵を安全に送ることが課題となる。このように、これまでの秘密鍵が1つだけの手法では、その鍵を安全に送ることが難しい。

そこで登場したのが公開鍵暗号方式である。公開鍵暗号方式では、その名の通り公開鍵は全世界の誰にでも公開しても問題がない。そのため、これまでの課題であった鍵を安全に送ることを気にする必要がないのである。この暗号方式では、まず情報を送ってほしい(情報の受け取り手)のBさんが秘密鍵と公開鍵の2つの鍵を生成する。そして、その内の公開鍵を好きな手段で情報を送るAさんに伝える。Aさんは、受け取った公開鍵を使ってメッセージを暗号化する。Aさんは暗号化したメッセージをBさんに送る。Bさんは受け取った暗号を秘密鍵で復号化してメッセージを読むことができる。これが公開鍵暗号方式である。

従来の暗号方式と違って、悪意のあるCさんが通信を傍受しても手に入る情報は公開鍵と暗号文だけであり、それでは高性能なコンピュータを用いても暗号を復号することができない。復号することができないはずなのだが、なぜだか健二くんはこれを暗算で解いてしまっている。なぜ暗号文と公開鍵だけ手に入れても復号することが困難であるのか、実際に順を追ってわかりやすく説明してくれている動画が、冒頭で紹介したQuizKnockの動画である。ぜひ見てほしい。

## 第1問
文字列を数字で表現する方法

![image](https://user-images.githubusercontent.com/40447362/127762136-bd7cbb75-9dfa-4582-8075-5e6d74bc67bb.png)

```zsh.sh
$ python Q1.py
```

第1問は、(単純に文字コード変換とも考えられるが)古典暗号のように対応表に基づいて文字列を数字に変換するものである。対応はAなら01、Bなら02 … Zなら26というように、アルファベットの大文字が二桁の数字に置き換えている。

二桁の数字を大文字のアルファベットに変換するプログラムはこんな感じである。

``` decoder.py
# 入力された数字の形式の暗号を文字列に解読する
def decoder(input_number):
    return chr(int(input_number) + 64)
```

入力の`input_number`は01~26の二桁の数字で、まずそれを`int()`で整数に変換する。次に、ASCIIコードを使って数字を文字に変換する。ASCIIコードでは65がA、65がBというように対応しているので、今回であれば入力された数字に64を足せば良い。最後にこれを`chr()`で文字に変換するとうまくいく。

ただし、今回入力が二桁区切りではなくすべてくっついた状態で与えられるので、二桁ごとに分割する必要がある。

入力された二桁以上の数字を二桁ごとに分割してリストに格納する関数はこんな感じである。

```formatter.py
# 入力された数字の形式の暗号を二桁ごとに区切ってリストに格納する
def formatter(input_number):
    input_list =[]
    while input_number > 0:
        input_list.append(str(input_number%100).zfill(2))
        input_number //= 100
    input_list.reverse()
    return input_list
```

二桁ごとに分割したいので、100で割った商とあまりを考える。また、一桁の数字も一旦二桁ごとに分割したかったので、整数型ではなく文字列に変換し、`zfill(2)`メソッドで0埋めしている。

## 第2問
秘密鍵と公開鍵が与えられた状態で復号化

![image](https://user-images.githubusercontent.com/40447362/127762195-1b995f09-1468-4ff5-9d82-2a8a8ab135db.png)

```zsh.sh
$ python Q2.py
```
第2問はp, q, eの3つの鍵から暗号を復号化する問題である。ここで、p, qは公開鍵、秘密鍵を生成するために用いる素数のペアで、eは任意の正の整数である。N = p*qとeを公開鍵とし、秘密鍵dもp, q, eから求めることができ、mはdを求めるために必要な値で(p-1)と(q-1)の最小公倍数から求めることができる。cが暗号文、Mが復号化したメッセージである。それぞれの導出法は問題文にある通りである。


## 第3問
公開鍵Nからそれを構成する素数のペア(p, q)を求める

![image](https://user-images.githubusercontent.com/40447362/127762221-b350cfb7-7c73-4b3e-a377-5b651a670adf.png)

```zsh.sh
$ python Q3.py
```
第3問は2つの素数p, qをかけた数字を素因数分解する問題である。実装方法は色々あるが、今回は試し割り法を用いている。

動画内では電卓を使ってもかなり時間がかかっていたが、6桁程度であればコンピュータなら一瞬(150μs程度)だった。実際に使われているRSA暗号では桁数の大きな値が使われているため、コンピュータを使っても解けないというところで安全性が確保されている。

これを暗算でやってしまう健二くんとは一体……。


## 第4問、最終問題
動画内では第4問と最終問題で、「サマーウォーズ」の主人公、健二がいかにすごいこと(無理難題)をしているかが説明されている。ぜひ見てほしい。


## RSA_Decrypt.py
```zsh.sh
$ python RSA_Decrypt.py
```

これまでのQ1~Q2までの内容を使って公開鍵から暗号文を復号化するプログラムを作成した。


## サマーウォーズ
健二くんのすごさがわかれば、「サマーウォーズ」ももっと楽しめるはず！！

 [![](https://user-images.githubusercontent.com/40447362/127768286-e9b88d6f-e219-49da-9e9b-ffc8043a71c6.png)](https://www.amazon.co.jp/gp/video/detail/B07CLCVH9G/ref=atv_dp_share_cu_r)

https://www.amazon.co.jp/gp/video/detail/B07CLCVH9G/ref=atv_dp_share_cu_r
